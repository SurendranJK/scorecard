<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ScoreCard — Hewlett Packard Enterprise</title>
<style>
  :root{--hpe-blue:#00739D;--hpe-dark:#0b3b4a;--muted:#4d5a63;--bg:#f4f7f8;--panel:#ffffff;--panel-weak:#f1f7fb}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial;color:var(--muted);background:var(--bg);-webkit-font-smoothing:antialiased}
  .container{max-width:1200px;margin:28px auto;padding:18px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .title{font-weight:700;color:var(--hpe-blue);font-size:20px}
  .brand .subtitle{font-size:13px;color:#2c4b56}
  .controls{display:flex;gap:8px;align-items:center}
  .controls select,.controls button,.controls input{padding:8px 10px;border-radius:8px;border:1px solid #d7e6eb;background:white}
  .main-card{margin-top:16px;background:var(--panel);border-radius:12px;padding:18px;box-shadow:0 8px 28px rgba(10,20,30,0.06)}
  .top-stats{display:flex;gap:14px;flex-wrap:wrap}
  .stat-card{flex:1 1 30%;min-width:220px;background:var(--panel-weak);padding:18px;border-radius:8px;border:1px solid #e5f0f5;opacity:0;transform:translateY(8px);transition:all .45s ease}
  .stat-card.show{opacity:1;transform:none}
  .stat-label{font-size:13px;color:#6d7c84}
  .stat-value{font-size:22px;font-weight:700;color:var(--hpe-dark);margin-top:8px}
  .grid{display:grid;grid-template-columns:1fr 480px;gap:14px;margin-top:18px}
  .panel{background:var(--panel);padding:14px;border-radius:8px;border:1px solid #eaf5f9}
  .panel h3{margin:0;color:var(--hpe-blue);font-size:16px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eef6f9;font-size:13px;text-align:left}
  thead th{background:var(--hpe-blue);color:white;font-weight:600}
  .muted{color:#64767d;font-size:13px}
  .actions{display:flex;gap:10px;align-items:center}
  .small{font-size:12px;padding:6px 8px}
  .bottom-note{margin-top:12px;color:#66787f;font-size:13px}
  .info { padding:12px; border-radius:8px; background:#fff9e6; border:1px solid #ffdca8; color:#6a4b00; margin-bottom:12px; }
  .error { padding:12px; border-radius:8px; background:#fff1f1; border:1px solid #f2b0b0; color:#8b1a1a; margin-bottom:12px; }
  .delta-good { color: #0b7a3a; font-weight:700; }
  .delta-bad { color: #a12b2b; font-weight:700; }
  @media (max-width:980px){.grid{grid-template-columns:1fr}.stat-card{min-width:unset}}
  @media print{.controls, .topbar .actions {display:none} body{background:white}}
  .right-controls {display:flex; align-items:center; gap:8px;}
  .id-input {width:120px}
  .label-inline {font-size:13px;color:#6b7b86;margin-right:6px}
  .compare-row {display:flex;justify-content:space-between;align-items:center;padding:8px 0}
  .metric {flex:1}
  .values {width:220px;text-align:right}
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div>
          <div class="title">ScoreCard</div>
          <div class="subtitle">Hewlett Packard Enterprise — Live Performance</div>
        </div>
      </div>

      <div class="controls">
        <div class="muted">Month</div>
        <select id="monthSelect" title="Select month"></select>

        <div class="right-controls">
          <span class="label-inline">Employee ID</span>
          <input id="empInput" class="id-input" type="text" placeholder="eg 60154741" />
          <button id="apply" class="small">Apply</button>
          <button id="refresh" class="small">Refresh</button>
          <button id="print" class="small">Print</button>
        </div>
      </div>
    </div>

    <div class="main-card">
      <div id="status" class="muted">Loading data…</div>

      <div id="contentArea" style="display:none">
        <div class="top-stats" id="topStats"></div>

        <div class="grid">
          <div class="panel" id="leftPanel">
            <h3>PMPI Score</h3>
            <div id="pmpiArea" class="muted" style="margin-top:10px">Loading PMPI…</div>
          </div>

          <div class="panel" id="rightPanel">
            <h3>Riders / Parameters</h3>
            <div id="riderArea" class="muted" style="margin-top:10px">Loading Riders…</div>
          </div>
        </div>

        <!-- Comparison panel -->
        <div class="panel" id="comparePanel" style="margin-top:18px;">
          <h3>Monthly Targets — Comparison</h3>
          <div id="compareArea" class="muted" style="margin-top:10px">Loading targets…</div>
        </div>

        <div class="bottom-note">Make sure your Google Sheet is published (File → Publish to the web). Data updates when sheet updates.</div>
      </div>

      <div id="debugBox" style="display:none;margin-top:12px;"></div>
    </div>
  </div>

<script>
/*
  ScoreCard with Targets comparison
  - Keep the OPENSHEET_BASE sheet id the same; we call two tabs: "scores" and "targets"
  - targets tab must be named exactly "targets" and include Period (YYYY-MM) + metric columns
*/

(async function(){
  const SHEET_BASE = "1D7If5Nf1i2_f3OvUCxySkrE_IWUy_YgSl95-hDPDinw"; // your sheet id
  const OPENSHEET_SCORES = `https://opensheet.elk.sh/${SHEET_BASE}/scores`;
  const OPENSHEET_TARGETS = `https://opensheet.elk.sh/${SHEET_BASE}/targets`;
  const AUTO_REFRESH_MS = 0;

  // DOM refs
  const status = document.getElementById('status');
  const contentArea = document.getElementById('contentArea');
  const debugBox = document.getElementById('debugBox');
  const topStats = document.getElementById('topStats');
  const pmpiArea = document.getElementById('pmpiArea');
  const riderArea = document.getElementById('riderArea');
  const compareArea = document.getElementById('compareArea');
  const monthSelect = document.getElementById('monthSelect');
  const empInput = document.getElementById('empInput');
  const btnApply = document.getElementById('apply');
  const btnRefresh = document.getElementById('refresh');
  const btnPrint = document.getElementById('print');

  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const params = new URLSearchParams(window.location.search);
  let EMP_ID = (params.get('id') || '').trim();
  const URL_PERIOD = (params.get('period') || '').trim();
  const URL_YEAR = params.get('year');
  const URL_MONTH = params.get('month');

  if (EMP_ID) empInput.value = EMP_ID;

  function showStatus(msg, isError=false){
    if (isError) status.innerHTML = `<span class="error">${msg}</span>`;
    else status.innerHTML = `<span class="info">${msg}</span>`;
  }

  async function fetchJson(url){
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('Failed to fetch ' + url + ' : ' + r.status);
    return r.json();
  }

  function normalize(rows){
    if (!rows || !rows.length) return [];
    const firstKeys = Object.keys(rows[0]||{}).map(k=>String(k).trim());
    const looksLikeTitle = firstKeys.length === 1 || firstKeys.every(k => /^[\d\W]+$/.test(k) || k.length < 4);
    if (looksLikeTitle && rows.length > 1){
      const headers = Object.values(rows[1]).map(v => String(v||'').trim());
      const dataRows = rows.slice(2);
      if (headers.every(h => h)){
        return dataRows.map(r => {
          const vals = Object.values(r);
          const obj = {};
          headers.forEach((h,i)=> obj[h] = vals[i] ?? '');
          return obj;
        });
      }
    }
    return rows;
  }

  function collectPeriods(rows){
    const ks = Object.keys(rows[0]||{});
    const periodKey = ks.find(k=>/period/i.test(k));
    if (periodKey) return [...new Set(rows.map(r=>String(r[periodKey]||'').trim()).filter(Boolean))].sort().reverse();
    const yearKey = ks.find(k=>/year/i.test(k));
    const monthKey = ks.find(k=>/month/i.test(k));
    if (yearKey && monthKey){
      const set = new Set();
      rows.forEach(r=>{
        const y = String(r[yearKey]||'').trim();
        let m = String(r[monthKey]||'').trim();
        if (m && m.length===1) m = '0'+m;
        if (y && m) set.add(`${y}-${m}`);
      });
      return [...set].sort().reverse();
    }
    return [];
  }

  function detectIdKey(row){
    return Object.keys(row||{}).find(k=>/emp|id/i.test(k)) || Object.keys(row||{})[0];
  }

  function findRecord(rows, emp, period){
    const idKey = detectIdKey(rows[0]||{});
    const ks = Object.keys(rows[0]||{});
    const periodKey = ks.find(k=>/period|year/i.test(k));
    if (period && periodKey) {
      return rows.find(r => (String(r[idKey]||'').trim() === emp) && (String(r[periodKey]||'').trim() === period));
    }
    const matches = rows.filter(r => String(r[idKey]||'').trim() === emp);
    return matches.length ? matches[0] : null;
  }

  function findKey(rec, patterns){
    const ks = Object.keys(rec||{});
    for (const p of patterns){
      const re = new RegExp(p,'i');
      const found = ks.find(k=>re.test(k));
      if (found) return found;
    }
    return null;
  }

  function parsePct(v){
    if (v == null) return null;
    const s = String(v).trim();
    if (!s) return null;
    if (s.includes('%')) return parseFloat(s.replace('%',''))/100;
    const n = parseFloat(s);
    if (isNaN(n)) return null;
    // if value looks like 0.88 treat as fraction
    if (n <= 1) return n;
    return n; // numeric (e.g. counts)
  }

  function formatPct(v){
    if (v == null) return '--';
    if (typeof v === 'number') {
      // if value in 0..1 -> show percent
      if (v <= 1) return (v*100).toFixed(2) + '%';
      // else as number
      return String(v);
    }
    return String(v);
  }

  function renderTopStats(rec){
    topStats.innerHTML = '';
    const rows = [
      {label:'Engineer Name', val: rec[ findKey(rec,['name','engineer']) ] || rec['Engineer Name'] || ''},
      {label:'Onsite Response Met%', val: rec[ findKey(rec,['onsite','response']) ] || rec['Onsite Response Met%'] || '--'},
      {label:'Overall SLA%', val: rec[ findKey(rec,['overall','SLA']) ] || rec['Overall SLA%'] || '--'},
      {label:'TOTAL CLOSED VOLUME', val: rec[ findKey(rec,['total','volume','closed']) ] || rec['TOTAL CLOSED VOLUME'] || '--'},
      {label:'TTR Hours (Official)', val: rec[ findKey(rec,['ttr','TTR']) ] || '--'},
      {label:'100% DA', val: rec[ findKey(rec,['da','100%']) ] || rec['100% DA'] || '--'},
      {label:'PPMD', val: rec[ findKey(rec,['ppmd']) ] || '--'},
      {label:'PPMC', val: rec[ findKey(rec,['ppmc']) ] || '--'},
      {label:'ECASE SLA HG', val: rec[ findKey(rec,['hg','ECASE SLA HG']) ] || rec['ECASE SLA_HG'] || '--'}
    ];
    rows.forEach((r,i)=>{
      const div = document.createElement('div');
      div.className = 'stat-card';
      div.innerHTML = `<div class="stat-label">${r.label}</div><div class="stat-value">${r.val}</div>`;
      topStats.appendChild(div);
      setTimeout(()=>div.classList.add('show'), 120 * i);
    });
  }

  function renderPMPI(rec){
    pmpiArea.innerHTML = '<div class="muted">No PMPI data</div>';
    const key = findKey(rec, ['pmpi','p m p i','pm pi','pmpi score']);
    if (!key) return;
    let data = [];
    try { data = JSON.parse(rec[key]); }
    catch(e){
      const s = String(rec[key]||'').trim();
      if (!s) return;
      data = s.split(/\r?\n/).map(line=>{
        const parts = line.split('|').map(x=>x.trim());
        return {param:parts[0], actual:parts[1], score:parts[2]};
      }).filter(x=>x.param);
    }
    if (!data.length) return;
    let html = '<table><thead><tr><th>Parameters</th><th>Actual</th><th>PMPI Score</th></tr></thead><tbody>';
    data.forEach(d => html += `<tr><td>${d.param||''}</td><td>${d.actual||''}</td><td>${d.score||''}</td></tr>`);
    html += '</tbody></table>';
    pmpiArea.innerHTML = html;
  }

  function renderRiders(rec){
    riderArea.innerHTML = '<div class="muted">No Riders/Parameters</div>';
    const riderKey = findKey(rec, ['rider','riders']);
    const paramKey = findKey(rec, ['parameter','parameters','param']);
    let html = '';
    if (riderKey && rec[riderKey]) {
      try {
        const arr = JSON.parse(rec[riderKey]);
        if (Array.isArray(arr) && arr.length) {
          html += '<h4 style="margin:0 0 6px 0">Riders</h4><table><thead><tr><th>Parameter</th><th>Actual</th><th>Score</th></tr></thead><tbody>';
          arr.forEach(a => html += `<tr><td>${a.param||a[0]||''}</td><td>${a.actual||a[1]||''}</td><td>${a.score||a[2]||''}</td></tr>`);
          html += '</tbody></table>';
        }
      } catch(e){}
    }
    if (paramKey && rec[paramKey]) {
      try {
        const parr = JSON.parse(rec[paramKey]);
        if (Array.isArray(parr) && parr.length) {
          html += '<h4 style="margin:12px 0 6px 0">Parameters</h4><table><thead><tr><th>Parameter</th><th>Score</th></tr></thead><tbody>';
          parr.forEach(p => html += `<tr><td>${p.param||p[0]||''}</td><td>${p.score||p[1]||''}</td></tr>`);
          html += '</tbody></table>';
        }
      } catch(e){}
    }
    if (html) riderArea.innerHTML = html;
  }

  // Build comparison view between targetRow and recRow (engineer)
  function buildComparison(targetRow, recRow){
    // metrics to compare (order matters)
    const metrics = [
      {keyAliases:['Onsite Response Met%','Onsite Response Met%'], label:'Onsite Response Met%'},
      {keyAliases:['Overall SLA%','Overall SLA%'], label:'Overall SLA%'},
      {keyAliases:['TOTAL CLOSED VOLUME','TOTAL CLOSED VOLUME'], label:'TOTAL CLOSED VOLUME'},
      {keyAliases:['TTR Hours(Official)','TTR Hours(Official)','TTR Hours (Official)','TTR Hours_Official'], label:'TTR Hours (Official)'},
      {keyAliases:['100% DA','100% DA'], label:'100% DA'},
      {keyAliases:['PPMD','PPMD'], label:'PPMD'},
      {keyAliases:['PPMC','PPMC'], label:'PPMC'},
      {keyAliases:['ECASE SLA_HG','ECASE SLA HG','ECASE_SLA_HG'], label:'ECASE SLA HG'}
    ];

    let html = '';
    metrics.forEach(m=>{
      // find target key name from targetRow
      let tKey = null;
      for (const a of m.keyAliases){
        const found = Object.keys(targetRow||{}).find(k=>k.trim().toLowerCase() === a.trim().toLowerCase());
        if (found) { tKey = found; break; }
      }
      // find rec key similarly
      let rKey = null;
      for (const a of m.keyAliases){
        const found = Object.keys(recRow||{}).find(k=>k.trim().toLowerCase() === a.trim().toLowerCase());
        if (found) { rKey = found; break; }
      }

      const targetValRaw = tKey ? targetRow[tKey] : '';
      const recValRaw = rKey ? recRow[rKey] : '';

      // parse percentages if needed
      const tPct = parsePct(targetValRaw);
      const rPct = parsePct(recValRaw);

      // compute delta
      let deltaText = '--';
      let deltaClass = '';
      if (tPct != null && rPct != null) {
        // both numeric; if target is percent or ratio
        // treat as 'good' if r >= t
        const diff = rPct - tPct;
        const diffPct = (diff * 100);
        deltaText = (diffPct >= 0 ? '+' : '') + diffPct.toFixed(2) + '%';
        deltaClass = diff >= 0 ? 'delta-good' : 'delta-bad';
      } else {
        // non-percent numeric or missing - attempt numeric compare
        const tNum = parseFloat(String(targetValRaw||'').replace(/[^0-9.\-]/g,''));
        const rNum = parseFloat(String(recValRaw||'').replace(/[^0-9.\-]/g,''));
        if (!isNaN(tNum) && !isNaN(rNum)) {
          const diff = rNum - tNum;
          deltaText = (diff >= 0 ? '+' : '') + diff.toFixed(2);
          // decide good/bad — for counts maybe higher is good, for hours lower is good.
          // Heuristic: if label contains "Hours" or "TTR" then lower is better.
          if (/hour|ttr/i.test(m.label)) deltaClass = diff <= 0 ? 'delta-good' : 'delta-bad';
          else deltaClass = diff >= 0 ? 'delta-good' : 'delta-bad';
        } else {
          deltaText = '--';
          deltaClass = '';
        }
      }

      const targetText = (tPct != null) ? formatPct(tPct) : (tKey ? String(targetValRaw || '--') : '--');
      const recText = (rPct != null) ? formatPct(rPct) : (rKey ? String(recValRaw || '--') : '--');

      html += `<div class="compare-row">
        <div class="metric"><strong>${m.label}</strong></div>
        <div class="values"><span style="display:inline-block;width:70px;text-align:right">${targetText}</span> → <span style="display:inline-block;width:70px;text-align:right;margin-left:8px">${recText}</span> <span style="margin-left:12px" class="${deltaClass}">${deltaText}</span></div>
      </div>`;
    });

    compareArea.innerHTML = html;
  }

  // main loader
  async function load(){
    try {
      showStatus('Fetching scores & targets...');
      // fetch both sheets in parallel
      const [rawScores, rawTargets] = await Promise.all([
        fetchJson(OPENSHEET_SCORES),
        fetchJson(OPENSHEET_TARGETS).catch(()=>[])
      ]);

      const rows = normalize(rawScores || []);
      const targets = normalize(rawTargets || []);

      if (!rows.length) {
        showStatus('No data in sheet (scores)', true);
        contentArea.style.display = 'none';
        monthSelect.innerHTML = '<option value="">No months</option>';
        return;
      }

      showStatus('Sheet loaded — ' + rows.length + ' rows');

      // build periods from scores (same as before)
      const periods = collectPeriods(rows);
      monthSelect.innerHTML = '<option value="">Latest</option>';
      periods.forEach(p => {
        const [y,m] = p.split('-');
        const formatted = (monthNames[parseInt(m,10)-1] || m) + ' ' + y;
        const o = document.createElement('option'); o.value = p; o.textContent = formatted; monthSelect.appendChild(o);
      });
      if (URL_PERIOD) monthSelect.value = URL_PERIOD;

      // prefer typed input else url param
      EMP_ID = (empInput.value || EMP_ID || '').trim();
      if (EMP_ID) empInput.value = EMP_ID;

      let targetPeriod = URL_PERIOD || (URL_YEAR && URL_MONTH ? `${URL_YEAR}-${String(URL_MONTH).padStart(2,'0')}` : '');
      if (!targetPeriod && periods.length) targetPeriod = periods[0];

      const rec = findRecord(rows, EMP_ID, targetPeriod);
      if (!rec) {
        const periodPretty = targetPeriod ? ((monthNames[parseInt(targetPeriod.split('-')[1],10)-1] || targetPeriod.split('-')[1]) + ' ' + targetPeriod.split('-')[0]) : 'latest';
        const empText = EMP_ID ? `Employee ${EMP_ID}` : 'Employee (none)';
        showStatus(`No data found for ${empText} in ${periodPretty}.`, true);
        contentArea.style.display = 'none';
        return;
      }

      // find target row for this period
      const tRow = (targets || []).find(r => {
        const keys = Object.keys(r||{});
        const periodKey = keys.find(k=>/period/i.test(k));
        if (!periodKey) return false;
        return String(r[periodKey]||'').trim() === targetPeriod;
      });

      // render UI
      contentArea.style.display = 'block';
      renderTopStats(rec);
      renderPMPI(rec);
      renderRiders(rec);

      if (!tRow) {
        compareArea.innerHTML = `<div class="muted">No target row found for ${targetPeriod}. Add a row to the "targets" sheet with Period = ${targetPeriod}.</div>`;
      } else {
        buildComparison(tRow, rec);
      }

      const pretty = targetPeriod ? ((monthNames[parseInt(targetPeriod.split('-')[1],10)-1] || targetPeriod.split('-')[1]) + ' ' + targetPeriod.split('-')[0]) : '';
      showStatus(`Showing ${EMP_ID}${pretty ? ' — ' + pretty : ''}`, false);

    } catch (err) {
      showStatus('Error: ' + err.message, true);
      console.error(err);
    }
  }

  // initial load
  await load();

  // UI events
  btnApply.onclick = () => {
    const chosenMonth = monthSelect.value;
    const typedId = (empInput.value || '').trim();
    const q = new URLSearchParams(window.location.search);
    if (typedId) q.set('id', typedId);
    if (chosenMonth) q.set('period', chosenMonth); else q.delete('period');
    window.location.search = q.toString();
  };
  btnRefresh.onclick = () => load();
  btnPrint.onclick = () => window.print();

  if (AUTO_REFRESH_MS > 0) setInterval(load, AUTO_REFRESH_MS);
})();
</script>
</body>
</html>
