<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HPE Scorecard — Stack Rank</title>
<style>
body{font-family:Inter,Arial;background:#f7fafb;margin:0;color:#425563}
header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
h1{margin:0;color:#00739D;font-size:22px}
main{padding:20px}
input,select,button{padding:8px 10px;border-radius:6px;border:1px solid #ccd;}
button{background:#00739D;color:white;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px;background:white;border-radius:8px;overflow:hidden}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee}
th{background:#00739D;color:white}
td.good{color:green;font-weight:600}
td.bad{color:red;font-weight:600}
.top-right{text-align:right}
.stat{font-size:14px;margin:3px 0}
</style>
</head>
<body>
<header>
  <h1>HPE Engineer Scorecard</h1>
  <div class="top-right">
    <div id="engineerName" class="stat">Engineer: —</div>
    <div id="engineerId" class="stat">ID: —</div>
    <div id="stackRank" class="stat">Stack Rank: —</div>
  </div>
</header>

<main>
  <div>
    <label>Month:</label>
    <select id="monthSelect"></select>
    <label style="margin-left:10px;">Employee ID:</label>
    <input id="empInput" placeholder="60154741">
    <button id="apply">Apply</button>
  </div>

  <div id="status" style="margin-top:10px;color:#00739D"></div>
  <table id="scoreTable">
    <thead>
      <tr><th>Parameter</th><th>Target</th><th>Score</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script>
(async function(){
const SHEET_ID = "1D7If5Nf1i2_f3OvUCxySkrE_IWUy_YgSl95-hDPDinw";
const URL = `https://opensheet.elk.sh/${SHEET_ID}/scores`;
const TARGETS = {
  "Onsite Response Met%":0.90,
  "Overall SLA%":0.99,
  "TTR Hours(Official)":30,
  "100% DA":0.92,
  "PPMD":1.13,
  "ECASE SLA_M2M":0.97,
  "ECASE SLA_HG":0.95
};

const empInput=document.getElementById('empInput');
const monthSelect=document.getElementById('monthSelect');
const applyBtn=document.getElementById('apply');
const tbody=document.querySelector('#scoreTable tbody');
const engineerName=document.getElementById('engineerName');
const engineerId=document.getElementById('engineerId');
const stackRank=document.getElementById('stackRank');
const status=document.getElementById('status');

let DATA=[];

function parseNum(v){
  if(!v) return null;
  let s=String(v).trim();
  if(s.includes('%')) return parseFloat(s)/100;
  let n=parseFloat(s);
  return isNaN(n)?null:n;
}

function formatVal(v){
  if(v==null||v==='')return '--';
  if(v<=1) return (v*100).toFixed(2)+'%';
  return v;
}

function better(val,tgt,param){
  if(val==null||tgt==null) return null;
  const lowerBetter=/ttr|ppmd/i.test(param);
  return lowerBetter ? val<=tgt : val>=tgt;
}

function computeStackRanks(rows,period){
  let sameMonth=rows.filter(r=>r.Period==period);
  sameMonth.forEach(r=>{
    let met=0,total=0;
    for(let k in TARGETS){
      if(r[k]!=null){
        let val=parseNum(r[k]);
        let ok=better(val,TARGETS[k],k);
        if(ok!==null){total++; if(ok)met++;}
      }
    }
    r.MetCount=met; r.TotalCount=total;
    r.ScorePercent=total? (met/total)*100:0;
  });
  sameMonth.sort((a,b)=>{
    if(b.ScorePercent!=a.ScorePercent)return b.ScorePercent-a.ScorePercent;
    return (parseNum(b["TOTAL CLOSED VOLUME"])||0)-(parseNum(a["TOTAL CLOSED VOLUME"])||0);
  });
  sameMonth.forEach((r,i)=>r.StackRank=i+1);
  return sameMonth;
}

function showEngineer(empId,period){
  const monthRows=computeStackRanks(DATA,period);
  const row=monthRows.find(r=>String(r["Employee ID"])===empId);
  if(!row){
    status.textContent=`No data found for Employee ${empId} in ${period}`;
    engineerName.textContent='Engineer: —';
    engineerId.textContent='ID: —';
    stackRank.textContent='Stack Rank: —';
    tbody.innerHTML='';
    return;
  }
  engineerName.textContent='Engineer: '+(row["Engineer Name"]||'—');
  engineerId.textContent='ID: '+(row["Employee ID"]||'—');
  stackRank.textContent='Stack Rank: '+row.StackRank;
  status.textContent=`Showing ${period}`;
  tbody.innerHTML='';
  Object.keys(TARGETS).forEach(k=>{
    const val=parseNum(row[k]);
    const ok=better(val,TARGETS[k],k);
    const cls= ok==null ? '' : (ok?'good':'bad');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${k}</td><td>${formatVal(TARGETS[k])}</td><td class="${cls}">${formatVal(val)}</td>`;
    tbody.appendChild(tr);
  });
}

async function init(){
  const res=await fetch(URL);
  DATA=await res.json();
  const periods=[...new Set(DATA.map(r=>r.Period))].filter(Boolean).sort().reverse();
  monthSelect.innerHTML='';
  periods.forEach(p=>{
    const [y,m]=p.split('-');
    const monthName=new Date(`${y}-${m}-01`).toLocaleString('default',{month:'long'});
    const opt=document.createElement('option');
    opt.value=p; opt.textContent=`${monthName} ${y}`;
    monthSelect.appendChild(opt);
  });
  const params=new URLSearchParams(location.search);
  const emp=params.get('id')||''; if(emp) empInput.value=emp;
  const per=params.get('period')||periods[0];
  monthSelect.value=per;
  if(emp) showEngineer(emp,per);
}
applyBtn.onclick=()=>{
  const emp=empInput.value.trim();
  const per=monthSelect.value;
  if(!emp||!per)return alert("Enter Employee ID and select month");
  const q=new URLSearchParams(); q.set('id',emp); q.set('period',per);
  location.search=q.toString();
};
init();
})();
</script>
</body>
</html>
